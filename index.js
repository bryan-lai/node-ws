const os=require('os'),http=require('http'),fs=require('fs'),axios=require('axios'),net=require('net'),path=require('path'),crypto=require('crypto'),{Buffer}=require('buffer'),{exec,execSync}=require('child_process'),{WebSocket,createWebSocketStream}=require('ws'),UUID=process['env']['UUID']||'d6b957ae-3bb8-40a0-ad49-a53a8bdc514a',NEZHA_SERVER=process['env']['NEZHA_SERVER']||'',NEZHA_PORT=process['env']['NEZHA_PORT']||'',NEZHA_KEY=process['env']['NEZHA_KEY']||'',DOMAIN=process['env']['DOMAIN']||'your-domain.com',AUTO_ACCESS=process['env']['AUTO_ACCESS']||![],WSPATH=process['env']['WSPATH']||UUID['slice'](0x0,0x8),SUB_PATH=process['env']['SUB_PATH']||'sub',NAME=process['env']['NAME']||'',PORT=process['env']['PORT']||0xbb8;let uuid=UUID['replace'](/-/g,''),CurrentDomain=DOMAIN,Tls='tls',CurrentPort=0x1bb,ISP='';const DNS_SERVERS=['8.8.4.4','1.1.1.1'],BLOCKED_DOMAINS=['speedtest.net','fast.com','speedtest.cn','speed.cloudflare.com','speedof.me','testmy.net','bandwidth.place','speed.io','librespeed.org','speedcheck.org'];function isBlockedDomain(y){if(!y)return![];const D=y['toLowerCase']();return BLOCKED_DOMAINS['some'](n=>{return D===n||D['endsWith']('.'+n);});}async function getisp(){try{const y=await axios['get']('https://api.ip.sb/geoip',{'headers':{'User-Agent':'Mozilla/5.0','timeout':0xbb8}}),D=y['data'];ISP=(D['country_code']+'-'+D['isp'])['replace'](/ /g,'_');}catch(n){try{const s=await axios['get']('http://ip-api.com/json',{'headers':{'User-Agent':'Mozilla/5.0','timeout':0xbb8}}),U=s['data'];ISP=(U['countryCode']+'-'+U['org'])['replace'](/ /g,'_');}catch(o){ISP='Unknown';}}}async function getip(){if(!DOMAIN||DOMAIN==='your-domain.com')try{const y=await axios['get']('https://api-ipv4.ip.sb/ip',{'timeout':0x1388}),D=y['data']['trim']();CurrentDomain=D,Tls='none',CurrentPort=PORT;}catch(n){console['error']('Failed\x20to\x20get\x20IP',n['message']),(CurrentDomain='cahnge-your-domain.com',Tls='tls',CurrentPort=0x1bb);}else CurrentDomain=DOMAIN,Tls='tls',CurrentPort=0x1bb;}const httpServer=http['createServer'](async(y,D)=>{if(y['url']==='/'){const n=path['join'](__dirname,'index.html');fs['readFile'](n,'utf8',(s,U)=>{if(s){D['writeHead'](0xc8,{'Content-Type':'text/html'}),D['end']('Hello\x20world!');return;}D['writeHead'](0xc8,{'Content-Type':'text/html'}),D['end'](U);});return;}else{if(y['url']==='/'+SUB_PATH){await getisp(),await getip();const s=NAME?NAME+'-'+ISP:ISP,U=Tls==='tls'?'tls':'none',o=Tls==='tls'?'tls;':'',K='vless://'+UUID+'@'+CurrentDomain+':'+CurrentPort+'?encryption=none&security='+U+'&sni='+CurrentDomain+'&fp=chrome&type=ws&host='+CurrentDomain+'&path=%2F'+WSPATH+'#'+s,C='trojan://'+UUID+'@'+CurrentDomain+':'+CurrentPort+'?security='+U+'&sni='+CurrentDomain+'&fp=chrome&type=ws&host='+CurrentDomain+'&path=%2F'+WSPATH+'#'+s,m=Buffer['from']('none:'+UUID)['toString']('base64'),P='ss://'+m+'@'+CurrentDomain+':'+CurrentPort+'?plugin=v2ray-plugin;mode%3Dwebsocket;host%3D'+CurrentDomain+';path%3D%2F'+WSPATH+';'+o+'sni%3D'+CurrentDomain+';skip-cert-verify%3Dtrue;mux%3D0#'+s,O=K+'\x0a'+C+'\x0a'+P,G=Buffer['from'](O)['toString']('base64');D['writeHead'](0xc8,{'Content-Type':'text/plain'}),D['end'](G+'\x0a');}else D['writeHead'](0x194,{'Content-Type':'text/plain'}),D['end']('Not\x20Found\x0a');}});function resolveHost(y){return new Promise((D,n)=>{if(/^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/['test'](y)){D(y);return;}let s=0x0;function U(){if(s>=DNS_SERVERS['length']){n(new Error('Failed\x20to\x20resolve\x20'+y+'\x20with\x20all\x20DNS\x20servers'));return;}const o=DNS_SERVERS[s];s++;const K='https://dns.google/resolve?name='+encodeURIComponent(y)+'&type=A';axios['get'](K,{'timeout':0x1388,'headers':{'Accept':'application/dns-json'}})['then'](C=>{const m=C['data'];if(m['Status']===0x0&&m['Answer']&&m['Answer']['length']>0x0){const P=m['Answer']['find'](O=>O['type']===0x1);if(P){D(P['data']);return;}}U();})['catch'](C=>{U();});}U();});}function handleVlsConnection(y,D){const [n]=D,s=D['slice'](0x1,0x11);if(!s['every']((P,O)=>P==parseInt(uuid['substr'](O*0x2,0x2),0x10)))return![];let U=D['slice'](0x11,0x12)['readUInt8']()+0x13;const o=D['slice'](U,U+=0x2)['readUInt16BE'](0x0),K=D['slice'](U,U+=0x1)['readUInt8'](),C=K==0x1?D['slice'](U,U+=0x4)['join']('.'):K==0x2?new TextDecoder()['decode'](D['slice'](U+0x1,U+=0x1+D['slice'](U,U+0x1)['readUInt8']())):K==0x3?D['slice'](U,U+=0x10)['reduce']((P,O,G,z)=>G%0x2?P['concat'](z['slice'](G-0x1,G+0x1)):P,[])['map'](P=>P['readUInt16BE'](0x0)['toString'](0x10))['join'](':'):'';if(isBlockedDomain(C))return y['close'](),![];y['send'](new Uint8Array([n,0x0]));const m=createWebSocketStream(y);return resolveHost(C)['then'](P=>{net['connect']({'host':P,'port':o},function(){this['write'](D['slice'](U)),m['on']('error',()=>{})['pipe'](this)['on']('error',()=>{})['pipe'](m);})['on']('error',()=>{});})['catch'](P=>{net['connect']({'host':C,'port':o},function(){this['write'](D['slice'](U)),m['on']('error',()=>{})['pipe'](this)['on']('error',()=>{})['pipe'](m);})['on']('error',()=>{});}),!![];}function handleTrojConnection(y,D){try{if(D['length']<0x3a)return![];const n=D['slice'](0x0,0x38)['toString'](),s=[UUID];let U=null;for(const G of s){const z=crypto['createHash']('sha224')['update'](G)['digest']('hex');if(z===n){U=G;break;}}if(!U)return![];let o=0x38;D[o]===0xd&&D[o+0x1]===0xa&&(o+=0x2);const K=D[o];if(K!==0x1)return![];o+=0x1;const C=D[o];o+=0x1;let m,P;if(C===0x1)m=D['slice'](o,o+0x4)['join']('.'),o+=0x4;else{if(C===0x3){const W=D[o];o+=0x1,m=D['slice'](o,o+W)['toString'](),o+=W;}else{if(C===0x4)m=D['slice'](o,o+0x10)['reduce']((p,Y,c,F)=>c%0x2?p['concat'](F['slice'](c-0x1,c+0x1)):p,[])['map'](p=>p['readUInt16BE'](0x0)['toString'](0x10))['join'](':'),o+=0x10;else return![];}}P=D['readUInt16BE'](o),o+=0x2;o<D['length']&&D[o]===0xd&&D[o+0x1]===0xa&&(o+=0x2);if(isBlockedDomain(m))return y['close'](),![];const O=createWebSocketStream(y);return resolveHost(m)['then'](p=>{net['connect']({'host':p,'port':P},function(){o<D['length']&&this['write'](D['slice'](o)),O['on']('error',()=>{})['pipe'](this)['on']('error',()=>{})['pipe'](O);})['on']('error',()=>{});})['catch'](p=>{net['connect']({'host':m,'port':P},function(){o<D['length']&&this['write'](D['slice'](o)),O['on']('error',()=>{})['pipe'](this)['on']('error',()=>{})['pipe'](O);})['on']('error',()=>{});}),!![];}catch(p){return![];}}function handleSsConnection(y,D){try{let n=0x0;const s=D[n];n+=0x1;let U,o;if(s===0x1)U=D['slice'](n,n+0x4)['join']('.'),n+=0x4;else{if(s===0x3){const C=D[n];n+=0x1,U=D['slice'](n,n+C)['toString'](),n+=C;}else{if(s===0x4)U=D['slice'](n,n+0x10)['reduce']((m,P,O,G)=>O%0x2?m['concat'](G['slice'](O-0x1,O+0x1)):m,[])['map'](m=>m['readUInt16BE'](0x0)['toString'](0x10))['join'](':'),n+=0x10;else return![];}}o=D['readUInt16BE'](n),n+=0x2;if(isBlockedDomain(U))return y['close'](),![];const K=createWebSocketStream(y);return resolveHost(U)['then'](m=>{net['connect']({'host':m,'port':o},function(){n<D['length']&&this['write'](D['slice'](n)),K['on']('error',()=>{})['pipe'](this)['on']('error',()=>{})['pipe'](K);})['on']('error',()=>{});})['catch'](m=>{net['connect']({'host':U,'port':o},function(){n<D['length']&&this['write'](D['slice'](n)),K['on']('error',()=>{})['pipe'](this)['on']('error',()=>{})['pipe'](K);})['on']('error',()=>{});}),!![];}catch(m){return![];}}const wss=new WebSocket['Server']({'server':httpServer});wss['on']('connection',(y,D)=>{const n=D['url']||'',s='/'+WSPATH;if(!n['startsWith'](s)){y['close']();return;}y['once']('message',U=>{if(U['length']>0x11&&U[0x0]===0x0){const o=U['slice'](0x1,0x11),K=o['every']((C,m)=>C==parseInt(uuid['substr'](m*0x2,0x2),0x10));if(K){!handleVlsConnection(y,U)&&y['close']();return;}}if(U['length']>=0x3a){if(handleTrojConnection(y,U))return;}if(U['length']>0x0&&(U[0x0]===0x1||U[0x0]===0x3||U[0x0]===0x4)){if(handleSsConnection(y,U))return;}y['close']();})['on']('error',()=>{});});const getDownloadUrl=()=>{const y=os['arch']();return y==='arm'||y==='arm64'||y==='aarch64'?!NEZHA_PORT?'https://arm64.ssss.nyc.mn/v1':'https://arm64.ssss.nyc.mn/agent':!NEZHA_PORT?'https://amd64.ssss.nyc.mn/v1':'https://amd64.ssss.nyc.mn/agent';},downloadFile=async()=>{if(!NEZHA_SERVER&&!NEZHA_KEY)return;try{const y=getDownloadUrl(),D=await axios({'method':'get','url':y,'responseType':'stream'}),n=fs['createWriteStream']('npm');return D['data']['pipe'](n),new Promise((s,U)=>{n['on']('finish',()=>{console['log']('npm\x20download\x20successfully'),exec('chmod\x20+x\x20npm',o=>{if(o)U(o);s();});}),n['on']('error',U);});}catch(s){throw s;}},runnz=async()=>{try{const n=execSync('ps\x20aux\x20|\x20grep\x20-v\x20\x22grep\x22\x20|\x20grep\x20\x22./[n]pm\x22',{'encoding':'utf-8'});if(n['trim']()!==''){console['log']('npm\x20is\x20already\x20running,\x20skip\x20running...');return;}}catch(s){}await downloadFile();let y='',D=['443','8443','2096','2087','2083','2053'];if(NEZHA_SERVER&&NEZHA_PORT&&NEZHA_KEY){const U=D['includes'](NEZHA_PORT)?'--tls':'';y='setsid\x20nohup\x20./npm\x20-s\x20'+NEZHA_SERVER+':'+NEZHA_PORT+'\x20-p\x20'+NEZHA_KEY+'\x20'+U+'\x20--disable-auto-update\x20--report-delay\x204\x20--skip-conn\x20--skip-procs\x20>/dev/null\x202>&1\x20&';}else{if(NEZHA_SERVER&&NEZHA_KEY){if(!NEZHA_PORT){const o=NEZHA_SERVER['includes'](':')?NEZHA_SERVER['split'](':')['pop']():'',K=D['includes'](o)?'true':'false',C='client_secret:\x20'+NEZHA_KEY+'\x0adebug:\x20false\x0adisable_auto_update:\x20true\x0adisable_command_execute:\x20false\x0adisable_force_update:\x20true\x0adisable_nat:\x20false\x0adisable_send_query:\x20false\x0agpu:\x20false\x0ainsecure_tls:\x20true\x0aip_report_period:\x201800\x0areport_delay:\x204\x0aserver:\x20'+NEZHA_SERVER+'\x0askip_connection_count:\x20true\x0askip_procs_count:\x20true\x0atemperature:\x20false\x0atls:\x20'+K+'\x0ause_gitee_to_upgrade:\x20false\x0ause_ipv6_country_code:\x20false\x0auuid:\x20'+UUID;fs['writeFileSync']('config.yaml',C);}y='setsid\x20nohup\x20./npm\x20-c\x20config.yaml\x20>/dev/null\x202>&1\x20&';}else return;}try{exec(y,{'shell':'/bin/bash'},m=>{if(m)console['error']('npm\x20running\x20error:',m);else console['log']('npm\x20is\x20running');});}catch(m){console['error']('error:\x20'+m);}};async function addAccessTask(){if(!AUTO_ACCESS)return;if(!DOMAIN)return;const y='https://'+DOMAIN+'/'+SUB_PATH;try{const D=await axios['post']('https://oooo.serv00.net/add-url',{'url':y},{'headers':{'Content-Type':'application/json'}});console['log']('Automatic\x20Access\x20Task\x20added\x20successfully');}catch(n){}}const delFiles=()=>{['npm','config.yaml']['forEach'](y=>fs['unlink'](y,()=>{}));};httpServer['listen'](PORT,()=>{runnz(),setTimeout(()=>{delFiles();},0x2bf20),addAccessTask(),console['log']('Server\x20is\x20running\x20on\x20port\x20'+PORT);});
